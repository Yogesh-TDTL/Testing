name: Check Recent Committers and Notify Non-Committers

on:
  schedule:
    - cron: "0 * * * *"  # Runs every hour
  workflow_dispatch:  # Allows manual triggering

jobs:
  check-recent-committers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Install and Configure msmtp
        run: |
          sudo apt-get update && sudo apt-get install -y msmtp
          cat <<EOF > ~/.msmtprc
          defaults
          auth           login
          tls            on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          logfile        ~/.msmtp.log
          account hostinger
          host smtp.hostinger.com
          port 587
          user "${{ secrets.EMAIL_USERNAME }}"
          password "${{ secrets.EMAIL_PASSWORD }}"
          from "${{ secrets.EMAIL_USERNAME }}"
          account default : hostinger
          EOF
          chmod 600 ~/.msmtprc
      
      - name: List Collaborators and Check Recent Commit Activity
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MANAGER_USERNAME: "Yogesh-TDTL"  # Replace with actual manager's GitHub username
          EMAIL_USERNAME: "${{ secrets.EMAIL_USERNAME }}"
        run: |
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8
          
          echo "Fetching Collaborators..."
          COLLABORATORS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/collaborators" \
               | jq -r '.[].login')
          
          echo "Collaborators List:"
          echo "$COLLABORATORS"
          
          echo "\nRecent Committers (Last Hour):"
          COMMITTED=false
          NON_COMMITTED_USERS=""
          
          for user in $COLLABORATORS; do
            if [ "$user" = "$MANAGER_USERNAME" ]; then
              continue  # Skip manager
            fi
            
            echo "Checking commits for: $user"
            RECENT_COMMITS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                 -H "Accept: application/vnd.github.v3+json" \
                 "https://api.github.com/repos/${{ github.repository }}/commits?author=$user&since=$(date -u -d '1 hour ago' +"%Y-%m-%dT%H:%M:%SZ")" \
                 | jq length)
            
            if [ "$RECENT_COMMITS" -gt 0 ]; then
              echo "$user committed in the last hour ($RECENT_COMMITS commits)"
            else
              NON_COMMITTED_USERS+="$user\n"
            fi
          done
          
          echo "\nNon-Committers (Last Hour):"
          echo -e "$NON_COMMITTED_USERS"
          
          echo "Sending Reminder Emails..."
          echo "$NON_COMMITTED_USERS" | while IFS= read -r user; do
            EMAIL_TO="yogesh.more@thedatatechlabs.com"
            printf "From: $EMAIL_USERNAME\nTo: $EMAIL_TO\nSubject: ⚠️ Reminder - No Commit Today!\n\nHello ${user},\n\nYou haven't committed anything today. Please push your updates before the end of the day.\n\nBest,\nCloud Team" | msmtp --from=$EMAIL_USERNAME --host=smtp.hostinger.com --port=587 --auth=on --tls=on --user=$EMAIL_USERNAME --passwordeval "echo ${{ secrets.EMAIL_PASSWORD }}" "$EMAIL_TO"
            echo "Email sent to: $EMAIL_TO"
          done
